# ContentBot Architecture

## üèóÔ∏è –û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

ContentBot - –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Telegram –∫–∞–Ω–∞–ª–∞–º–∏ —Å –ò–ò-–æ–±—Ä–∞–±–æ—Ç–∫–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç–∞.

**–û—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫:**
1. **–ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫** ‚Üí 2. **–ü–∞—Ä—Å–∏–Ω–≥** ‚Üí 3. **LLM-–æ–±—Ä–∞–±–æ—Ç–∫–∞** ‚Üí 4. **–ü—É–±–ª–∏–∫–∞—Ü–∏—è**

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

### Core (–Ø–¥—Ä–æ —Å–∏—Å—Ç–µ–º—ã)
- `core/contentbot-main.js` - –≥–ª–∞–≤–Ω—ã–π –±–æ—Ç, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –º–æ–¥—É–ª–µ–π
- `core/channel-manager.js` - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞–º–∏, –ø—É–±–ª–∏–∫–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤
- `core/database.js` - –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö SQLite, —Å—Ö–µ–º—ã —Ç–∞–±–ª–∏—Ü

### Parsers (–ü–∞—Ä—Å–∏–Ω–≥ –∫–æ–Ω—Ç–µ–Ω—Ç–∞)
- `parsers/content-parser.js` - –ø–∞—Ä—Å–µ—Ä Telegram –∫–∞–Ω–∞–ª–æ–≤ —á–µ—Ä–µ–∑ MTProto
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `telegram_parser` (—Å–∏–º–ª–∏–Ω–∫ –Ω–∞ `/root/tgparser`)

### LLM (–ò–ò-–æ–±—Ä–∞–±–æ—Ç–∫–∞)
- `llm/llm-rewriter.js` - –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏–µ, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è, —É–ª—É—á—à–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenRouter —á–µ—Ä–µ–∑ `OpenRouterManager`

### Scripts (–°–∫—Ä–∏–ø—Ç—ã –∏ —É—Ç–∏–ª–∏—Ç—ã)
- `scripts/build_topic_catalog_improved.js` - –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ 46 —Ç–µ–º–∞—Ç–∏–∫
- `scripts/global_search_post.js` - –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ + –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤
- `scripts/ai_battle_post.js` - AI-–±–∞—Ç–ª—ã –º–µ–∂–¥—É –º–æ–¥–µ–ª—è–º–∏
- `scripts/architecture_post.js` - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
- `scripts/collect_battle_sources.js` - —Å–±–æ—Ä –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–ª—è –±–∞—Ç–ª–æ–≤

### Data (–î–∞–Ω–Ω—ã–µ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
- `data/topic_channels_catalog_improved.json` - –∫–∞—Ç–∞–ª–æ–≥ 46 —Ç–µ–º–∞—Ç–∏–∫ —Å –∫–∞–Ω–∞–ª–∞–º–∏
- `data/topic_synonyms.json` - —Å–∏–Ω–æ–Ω–∏–º—ã –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞
- `data/last_battle_sources.json` - –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–ª—è AI-–±–∞—Ç–ª–æ–≤

### Docs (–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è)
- `docs/LLM_MODEL_EVAL.md` - –æ—Ü–µ–Ω–∫–∞ LLM-–º–æ–¥–µ–ª–µ–π
- `docs/TOPIC_CATALOG_IMPROVED.md` - –∫–∞—Ç–∞–ª–æ–≥ —Ç–µ–º–∞—Ç–∏–∫
- `docs/SCRIPTS_GUIDE.md` - —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Å–∫—Ä–∏–ø—Ç–∞–º

### Config (–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)
- `ecosystem.config.js` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è PM2
- `env/ContentBot.txt` - –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

## üîÑ –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

### 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
```javascript
// contentbot-main.js
await this.db.init();           // –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
await this.parser.init();       // MTProto –∫–ª–∏–µ–Ω—Ç
await this.channelManager.init(this.parser.client); // –ü–µ—Ä–µ–¥–∞—á–∞ –∫–ª–∏–µ–Ω—Ç–∞
await this.bot.start();         // Telegram –±–æ—Ç
```

### 2. –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –∫–∞–Ω–∞–ª–æ–≤
```javascript
// build_topic_catalog_improved.js
const channels = await client.invoke(new Api.contacts.Search({
  q: searchQuery,
  limit: 100
}));
const filtered = channels.chats.filter(c => c.participantsCount >= 50);
```

### 3. –ü–∞—Ä—Å–∏–Ω–≥ –∏ —Å–∏–Ω—Ç–µ–∑ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
```javascript
// global_search_post.js
const sources = await fetchChannelContent(channels, 2);
const prompt = synthesizeContent(sources, topic);
```

### 4. LLM-–æ–±—Ä–∞–±–æ—Ç–∫–∞
```javascript
// llm-rewriter.js
const response = await this.ai.makeRequest(prompt, {
  modelOverride: 'qwen/qwen3-235b-a22b-2507',
  max_tokens: 10000
});
```

### 5. –ü—É–±–ª–∏–∫–∞—Ü–∏—è
```javascript
// channel-manager.js
await bot.api.sendMessage(channelId, formattedPost);
```

## ü§ñ LLM Layer (OpenRouter)

### –ü—Ä–æ–≤–∞–π–¥–µ—Ä
- **OpenRouter** - –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä
- **Cloud.ru** - –æ—Ç–∫–ª—é—á–µ–Ω
- **Fallback** - –ª–æ–∫–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞

### API –ö–ª—é—á–∏
- `OPENROUTER_API_KEY_PAID` - –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª—é—á
- –†–æ—Ç–∞—Ü–∏—è –∫–ª—é—á–µ–π –æ—Ç–∫–ª—é—á–µ–Ω–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏

### –¢–µ–∫—É—â–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–µ–π

| –ó–∞–¥–∞—á–∞ | –ú–æ–¥–µ–ª—å | –¢–æ–∫–µ–Ω—ã | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|--------|--------|----------|
| **–û—Å–Ω–æ–≤–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è** | `qwen/qwen3-235b-a22b-2507` | 10000 | PRIMARY –º–æ–¥–µ–ª—å |
| **Fallback** | `deepseek/deepseek-r1-0528-qwen3-8b:free` | 10000 | FALLBACK –º–æ–¥–µ–ª—å |
| **AI-–±–∞—Ç–ª—ã** | –í—Å–µ —Ç–æ–ø–æ–≤—ã–µ –º–æ–¥–µ–ª–∏ | 10000 | –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ |

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤
- `max_tokens: 10000` - –ø–æ–ª–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞
- `temperature: 0.7` - –±–∞–ª–∞–Ω—Å –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏
- –ü—Ä–µ–º–∏—É–º –º–æ–¥–µ–ª–∏ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü—ã
- `users` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ—Ç–∞
- `channels` - –∫–∞–Ω–∞–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `posts` - –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã
- `payments` - –∏—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
- `content_sources` - –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞

### –°—Ö–µ–º–∞
```sql
CREATE TABLE users (
  id INTEGER PRIMARY KEY,
  telegram_id BIGINT UNIQUE,
  username TEXT,
  subscription_status TEXT,
  created_at DATETIME
);
```

## üîß –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
```env
# Telegram
BOT_TOKEN=8312811183:AAEIHiM-KbdLNylg_tsqUPfn2h41yL7DH60
TG_API_ID=24120142
TG_API_HASH=5792c2ada7d1f4d1d3f91938a5caa7a7
SESSION_FILE=/root/tgparser/.session.txt

# OpenRouter
OPENROUTER_API_KEY_PAID=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

# ContentBot
MONTHLY_PRICE=3000
CHANNEL_SETUP_PRICE=10000
PREMIUM_PRICE=15000
OWNER_ID=123456789
```

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ
```env
# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ OpenRouter –∫–ª—é—á–∏
OPENROUTER_API_KEY1=sk-or-v1-...
OPENROUTER_API_KEY2=sk-or-v1-...
# ... –¥–æ OPENROUTER_API_KEY13
```

## üöÄ PM2 –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### ecosystem.config.js
```javascript
module.exports = {
  apps: [{
    name: 'contentbot',
    script: 'npm',
    args: 'start',
    cwd: '/root/contentbot',
    env: {
      NODE_ENV: 'production',
      BOT_TOKEN: '8312811183:AAEIHiM-KbdLNylg_tsqUPfn2h41yL7DH60',
      TG_API_ID: '24120142',
      TG_API_HASH: '5792c2ada7d1f4d1d3f91938a5caa7a7',
      SESSION_FILE: '/root/tgparser/.session.txt'
    }
  }]
};
```

### –ö–æ–º–∞–Ω–¥—ã PM2
```bash
pm2 start ecosystem.config.js
pm2 restart contentbot --update-env
pm2 logs contentbot
pm2 status
```

## üé® –°—Ç–∏–ª–∏ –Ω–∞–ø–∏—Å–∞–Ω–∏—è

### –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç–∏–ª–∏
- **–º–æ—Ç–∏–≤–∞—Ü–∏—è** üî• - –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π –∏ —ç–Ω–µ—Ä–≥–∏—á–Ω—ã–π
- **–±–∏–∑–Ω–µ—Å** üíº - –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–π
- **—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏** ü§ñ - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π
- **–ø—Å–∏—Ö–æ–ª–æ–≥–∏—è** üß† - –ø–æ–Ω–∏–º–∞—é—â–∏–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π
- **—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π** ‚ú® - –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –ø–æ–∑–Ω–∞–≤–∞—Ç–µ–ª—å–Ω—ã–π

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
1. **–ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞–Ω–∏–µ** - —É–Ω–∏–∫–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞
2. **–≠–º–æ–¥–∑–∏** - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ —Å—Ç–∏–ª—é
3. **CTA** - –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é
4. **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –¢–æ–∫–µ–Ω—ã
- –í—Å–µ —Ç–æ–∫–µ–Ω—ã –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –ú–∞—Å–∫–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ª–æ–≥–∞—Ö
- –†–æ—Ç–∞—Ü–∏—è OpenRouter –∫–ª—é—á–µ–π

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- –õ–∏–º–∏—Ç—ã Telegram API
- –ê–Ω—Ç–∏-—Å–ø–∞–º –∑–∞—â–∏—Ç–∞
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏
- `logs/contentbot-error.log` - –æ—à–∏–±–∫–∏
- `logs/contentbot-out.log` - –≤—ã–≤–æ–¥
- `logs/contentbot-combined.log` - –≤—Å–µ –ª–æ–≥–∏

### –ú–µ—Ç—Ä–∏–∫–∏
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤
- –í–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ LLM
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç LLM
```bash
cd /root/contentbot
node -e "
const { LLMRewriter } = require('./llm/llm-rewriter');
(async()=>{
  const llm = new LLMRewriter();
  const gen = await llm.generateFromScratch('–º–æ—Ç–∏–≤–∞—Ü–∏—è –∫ —É—á–µ–±–µ','–º–æ—Ç–∏–≤–∞—Ü–∏—è');
  console.log('GEN:', (gen&&gen.text||'').slice(0,120));
  const rw = await llm.rewriteContent({text:'–£—Å–ø–µ—Ö –ø—Ä–∏—Ö–æ–¥–∏—Ç –∫ —Ç–µ–º, –∫—Ç–æ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –¥–µ–ª–∞–µ—Ç –º–∞–ª–µ–Ω—å–∫–∏–π —à–∞–≥ –≤–ø–µ—Ä–µ–¥.'},'—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π');
  console.log('RW:', (rw&&rw.text||'').slice(0,120));
})().catch(console.error);
"
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
```bash
pm2 status
pm2 logs contentbot --lines 50
```

## üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### Telegram Parser
- –°–∏–º–ª–∏–Ω–∫: `/root/contentbot/telegram_parser` ‚Üí `/root/tgparser`
- MTProto –∫–ª–∏–µ–Ω—Ç –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
- –°–µ—Å—Å–∏—è: `/root/tgparser/.session.txt`

### OpenRouter
- –ü—Ä–µ–º–∏—É–º –º–æ–¥–µ–ª–∏: Qwen3-235B-A22B, DeepSeek R1-0528
- –ü–ª–∞—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã
- Fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É

### –ö–∞—Ç–∞–ª–æ–≥ —Ç–µ–º–∞—Ç–∏–∫
- 46 —Ç–µ–º–∞—Ç–∏–∫ —Å –Ω–∞–π–¥–µ–Ω–Ω—ã–º–∏ –∫–∞–Ω–∞–ª–∞–º–∏
- –£–ª—É—á—à–µ–Ω–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –ø–æ–∏—Å–∫–∞ —Å —Å–∏–Ω–æ–Ω–∏–º–∞–º–∏
- –¢–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–µ—Ä–µ–∑ GetFullChannel

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- –ü–æ–ª–Ω—ã–µ LLM –æ—Ç–≤–µ—Ç—ã (10000 —Ç–æ–∫–µ–Ω–æ–≤) –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
- –°—Ç–∞–±–∏–ª—å–Ω—ã–π API –∫–ª—é—á

### –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ
- PM2 –∫–ª–∞—Å—Ç–µ—Ä —Ä–µ–∂–∏–º
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö SQLite
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ñ–∞–π–ª—ã
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤

---

**ContentBot Architecture** - –ø–æ–ª–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è Telegram –∫–∞–Ω–∞–ª–æ–≤ —Å –ò–ò! üöÄ

